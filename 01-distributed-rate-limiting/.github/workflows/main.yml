name: Enterprise CI Pipeline

on:
  push:
    branches: [ "main" ]
    paths:
      - '01-distributed-rate-limiting/**' # Só roda se mexer nesta pasta (Monorepo friendly)
  pull_request:
    branches: [ "main" ]
    paths:
      - '01-distributed-rate-limiting/**'

jobs:
  quality-and-test:
    runs-on: ubuntu-latest
    
    # Estratégia Enterprise: Service Containers
    # Subimos um Redis real para os testes de integração funcionarem no CI
    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: ./01-distributed-rate-limiting

    steps:
    - name: Checkout do Código
      uses: actions/checkout@v4

    - name: Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip' # Cache inteligente de dependências

    - name: Instalar Dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verificar Formatação (Linting)
      # Falha se o código não seguir PEP 8 (Black) ou imports desordenados (Isort)
      run: |
        echo "Verificando imports com Isort..."
        isort . --check-only --diff
        echo "Verificando formatação com Black..."
        black . --check --diff

    - name: Executar Testes de Estresse/Integração
      # Como temos o Redis rodando via 'services', o teste vai conectar no localhost:6379
      run: |
        # Iniciamos a API em background
        nohup uvicorn main:app --host 0.0.0.0 --port 8000 &
        
        # Aguarda a API subir (Health Check simples)
        timeout 10s bash -c 'until curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health | grep "200"; do sleep 1; done'
        
        # Executa o script de teste
        python test_stress.py
